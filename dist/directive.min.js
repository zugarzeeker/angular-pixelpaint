/*!
 * angular-directive-boilerplate
 * 
 * Version: 0.0.10 - 2016-06-30T09:18:33.885Z
 * License: MIT
 */
/*!
 * angular-directive-boilerplate
 *
 * Version: 0.0.8 - 2016-06-16T07:54:28.642Z
 * License: MIT
 */
"use strict";angular.module("angularPixelPaint",[]).directive("pixelPaint",["$document","$window","$q","$timeout","$log",function(e,t,i,n,a){function l(e,t){t[0].style.overflow="scroll",t.css("width",t[0].style.width||"500px"),t.css("height",t[0].style.height||"500px")}function o(i,o){l(i,o),t.el=o;var r,c,s,f,d,u=e[0].createElement("canvas"),h=u.getContext("2d");o.addClass("pixelpaint");var g=angular.element(o[0].querySelector(".layers-container")),v=function(){return Math.floor(Math.min(o[0].offsetWidth,o[0].offsetHeight))},m=function(e){return Math.floor(v()/e)},p=function(e){return Math.floor(v()/e)},S=15,y=20,x=10,z=(y-x)/2,b=function(){p(i.options.cellSize)-S>z/2+1&&(i.options.cellSize=m(S))};b();var w=function(e){return e<x||e>y},C=[],W={cellSize:m(S),largeGridEvery:10,gridLineWidth:1,gridSubDivisionLineWidth:.5,imageWidth:10,imageHeight:10,showGrid:!0,brushColor:[0,0,0],paintEnabled:!0},D="move",E={x:0,y:0},L={x:0,y:0},R={x:0,y:0};r=i.$watch("options",function(e,t){e.cellSize>0&&!w(p(e.cellSize))&&(W=Object.assign(W,i.options),e.cellSize!==t.cellSize&&angular.forEach(C,function(e){e.element[0].width=e.element[0].width/t.cellSize*W.cellSize,e.element[0].height=e.element[0].height/t.cellSize*W.cellSize,e.element[0].style.transform="translate("+e.offset.x*W.cellSize+"px,"+e.offset.y*W.cellSize+"px)",A(e)}))},!0),c=i.$watch("layers",function(e,t){$(e,t)},!0),s=i.$watch("shouldGenerateOutputImage",function(e){e&&(U(),n(function(){i.shouldGenerateOutputImage=!1}))}),d=i.$watch("selectedTool",function(e,t){a.info("oldValue = "+t),a.info("newValue = "+e),D=e,"move"==D&&O(null)}),f=i.$watch("revision",function(e){});var I=new Hammer(o[0]);I.on("tap",function(e){Y(e)}),I.on("panstart",function(e){P(e)}),I.on("panmove",function(e){j(e)}),I.on("panend",function(e){k(e)});var $=function(e,t){o[0].querySelectorAll(".btn-remove").forEach(function(e){e.parentNode.removeChild(e)}),angular.forEach(e,function(e,i){angular.isDefined(t)&&i<t.length?angular.equals(t[i],e)||M(e,i):M(e)})},M=function(t,i){var n={offset:{x:0,y:0}};i<C.length&&"text"===C[i].type&&(n.offset=C[i].offset);var a=Object.assign({},t,n);a.element=angular.element("<canvas></canvas>");var l=a.offset.x*W.cellSize,r=a.offset.y*W.cellSize;if(a.element[0].width=W.imageWidth*W.cellSize,a.element[0].height=W.imageHeight*W.cellSize,a.element[0].style.transform="translate("+l+"px,"+r+"px)","text"===a.type&&(a.element.addClass("text"),a.btnRemove=angular.element('<button class="btn-remove"><span class="close"></span></button>'),a.btnRemove[0].style.transform="translate("+(l-16)+"px,"+(r-16)+"px)",o.append(a.btnRemove),a.btnRemove.on("click",function(){G(a),a.btnRemove.remove()})),a.active&&(a.element.addClass("active"),a.btnRemove&&a.btnRemove.addClass("active")),angular.isDefined(i)?(C[i]=a,g.find("canvas").eq(i).replaceWith(a.element)):(C.push(a),g.append(a.element)),a.dataCanvas=e[0].createElement("canvas"),a.dataCanvas.width=a.element[0].width,a.dataCanvas.height=a.element[0].height,a.image){var c=new Image;c.onload=function(){var e=a.dataCanvas.getContext("2d");e.drawImage(c,0,0),A(a)},c.src=a.image}else A(a)},G=function(e){var t=-1;angular.forEach(C,function(i,n){i===e&&(t=n)}),t!==-1&&(C[t].element.remove(),C.splice(t,1),i.layers.splice(t,1)),a.info(i.layers),n(function(){i.$digest()})},q=function(e,t,i,n,a,l,o){var r=e.getContext("2d"),c=h.createImageData(1,1);c.data[0]=n,c.data[1]=a,c.data[2]=l,c.data[3]=o,r.putImageData(c,t,i)},H=function(){var e=C[0];return angular.forEach(C,function(t){t.active&&(e=t)}),e},O=function(e){angular.forEach(C,function(t,n){n===e?(t.active=!0,t.element.addClass("active"),t.btnRemove&&t.btnRemove.addClass("active"),n<i.layers.length&&(i.layers[n].active=!0)):(t.active=!1,t.element.removeClass("active"),t.btnRemove&&t.btnRemove.addClass("active"),n<i.layers.length&&(i.layers[n].active=!1))}),n(function(){i.$digest()})},X=function(e){var t=H();if(e.pointers.length>0){var i=t.element[0].getBoundingClientRect(),n=e.pointers[0].clientX-i.left,a=e.pointers[0].clientY-i.top,l=Math.floor(n/W.cellSize),o=Math.floor(a/W.cellSize);W.paintEnabled&&(q(t.dataCanvas,l,o,W.brushColor[0],W.brushColor[1],W.brushColor[2],255),N(t,l,o,W.brushColor[0],W.brushColor[1],W.brushColor[2],255))}},Y=function(e){if("move"==D)E.x=e.pointers[0].clientX,E.y=e.pointers[0].clientY;else{var t=H();if(e.target===t.element[0])"text"!==t.type&&X(e);else{var i;angular.forEach(C,function(t,n){t.element[0]===e.target&&(i=n)}),O(i)}}},P=function(e){if("move"==D)E.x=e.pointers[0].clientX,E.y=e.pointers[0].clientY,L.x=R.x,L.y=R.y;else{var t=H();"text"===t.type?(E.x=e.pointers[0].clientX,E.y=e.pointers[0].clientY,L.x=t.offset.x,L.y=t.offset.y):X(e)}},T=function(e){return Math.floor(e/W.cellSize)*W.cellSize},j=function(e){if("move"==D){a.info("onPanMove [Move]");var t={};t.x=L.x*W.cellSize+(e.pointers[0].clientX-E.x),t.y=L.y*W.cellSize+(e.pointers[0].clientY-E.y),R.x=Math.floor(t.x/W.cellSize),R.y=Math.floor(t.y/W.cellSize),o[0].querySelector(".layers-container").style.transform="translate("+T(t.x)+"px,"+T(t.y)+"px)"}else{var i=H();if("text"===i.type){var n=L.x*W.cellSize+(e.pointers[0].clientX-E.x),l=L.y*W.cellSize+(e.pointers[0].clientY-E.y);i.offset.x=Math.floor(n/W.cellSize),i.offset.y=Math.floor(l/W.cellSize);var r=i.offset.x*W.cellSize,c=i.offset.y*W.cellSize;i.element[0].style.transform="translate("+r+"px,"+c+"px)",i.btnRemove[0].style.transform="translate("+(r-16)+"px,"+(c-16)+"px)"}else X(e)}},k=function(){"move"==D?a.info("onPanEnd [Move]"):(angular.forEach(C,function(e,t){"image"===e.type&&t<i.layers.length&&(i.layers[t].image=e.dataCanvas.toDataURL("image/png"))}),n(function(){i.$digest()}))},A=function(e){"image"===e.type?F(e):"text"===e.type&&V(e)},B=function(e,t,i,n){i.font=n+" "+(t.fontFamily||"Arial"),i.textBaseline="top",i.fillStyle=t.color,i.fillText(e,0,0)},V=function(e){var t=angular.element("<canvas></canvas>"),i=t[0];i.width=1e4,i.height=1e4;var n=i.getContext("2d"),l=e.fontSize||"10px",o=e.text||"text";B(o,e,n,l);var r=n.measureText(o);i.width=r.width,i.height=1.5*parseInt(l),n=i.getContext("2d"),B(o,e,n,l),e.element[0].width=r.width*W.cellSize,e.element[0].height=1.5*parseInt(l)*W.cellSize,a.info(parseInt(l));for(var c,s=n.getImageData(0,0,r.width,1.5*parseInt(l)),f=0;f<s.height;f++)for(var d=0;d<s.width;d++)c=4*(f*s.width+d),s.data[c+3]=s.data[c+3]>50?255:0;var u=e.dataCanvas.getContext("2d");u.putImageData(s,0,0),F(e)},F=function(e){var t,i,n,a,l,o,r,c,s=e.element[0].getContext("2d"),f=e.dataCanvas.getContext("2d"),d=f.getImageData(0,0,e.element[0].width/W.cellSize,e.element[0].height/W.cellSize);s.clearRect(0,0,e.element[0].width,e.element[0].height);for(var u=0;u<d.height;u++)for(var h=0;h<d.width;h++)t=4*(u*d.width+h),i=d.data[t],n=d.data[t+1],a=d.data[t+2],o=d.data[t+3],l=o/255,W.showGrid?(r=W.gridSubDivisionLineWidth,c=W.gridSubDivisionLineWidth,h%W.largeGridEvery===0&&(r=W.gridLineWidth),u%W.largeGridEvery===0&&(c=W.gridLineWidth),s.fillStyle="rgba("+i+","+n+", "+a+", "+l+")",s.fillRect(.5+W.cellSize*h+W.gridSubDivisionLineWidth+r,.5+W.cellSize*u+W.gridSubDivisionLineWidth+c,W.cellSize-2*W.gridSubDivisionLineWidth-r,W.cellSize-2*W.gridSubDivisionLineWidth-c)):(s.fillStyle="rgba("+i+","+n+", "+a+", "+l+")",s.fillRect(W.cellSize*h,W.cellSize*u,W.cellSize,W.cellSize))},N=function(e,t,i,n,a,l,o){var r=e.element[0].getContext("2d");if(r.fillStyle="rgba("+n+","+a+", "+l+", "+o+")",W.showGrid){var c=W.gridSubDivisionLineWidth,s=W.gridSubDivisionLineWidth;t%W.largeGridEvery===0&&(c=W.gridLineWidth),i%W.largeGridEvery===0&&(s=W.gridLineWidth),r.fillRect(.5+W.cellSize*t+W.gridSubDivisionLineWidth+c,.5+W.cellSize*i+W.gridSubDivisionLineWidth+s,W.cellSize-2*W.gridSubDivisionLineWidth-c,W.cellSize-2*W.gridSubDivisionLineWidth-s)}else r.fillRect(W.cellSize*t,W.cellSize*i,W.cellSize,W.cellSize)},U=function(){var e=angular.element("<canvas></canvas>"),t=e[0];t.width=W.imageWidth,t.height=W.imageHeight;var n=t.getContext("2d");angular.forEach(C,function(e){n.drawImage(e.dataCanvas,e.offset.x,e.offset.y)}),i.outputImage=n.getImageData(0,0,W.imageWidth,W.imageHeight)};i.$on("$destroy",function(){r(),c(),s(),f(),d()}),W=Object.assign(W,i.options),$(i.layers,[])}var r={restrict:"E",scope:{layers:"=",options:"=",shouldGenerateOutputImage:"=",outputImage:"=",revision:"=",selectedTool:"="},template:'<div class="layers-container"></div>',link:o};return r}]);